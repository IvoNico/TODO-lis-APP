<!DOCTYPE html>
<html lang="en">
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mi Todo</title>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
<style>
:root{
  --bg:#0b0d12; --card:#0f172a; --stroke:#1f2a44;
  --text:#e5e7eb; --muted:#9aa6bf;
  --blue:#2563eb; --blue-500:#3b82f6;
  --e:cubic-bezier(.2,.8,.2,1);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.container{width:min(420px,90vw);margin:40px auto}
.perfil h1{font-size:1.5rem;margin-bottom:6px}
#fecha{color:var(--muted);display:block;margin-bottom:8px;text-transform:capitalize}
.date-controls{display:flex;gap:8px;align-items:center;margin:8px 0 14px}
.date-controls input[type="date"]{background:var(--card);border:1px solid var(--stroke);color:var(--text);padding:8px 10px;border-radius:10px;outline:none}
.icon-btn{width:40px;height:40px;border-radius:10px;border:1px solid var(--stroke);background:var(--card);color:var(--text);cursor:pointer;transition:transform .2s var(--e),border-color .2s var(--e)}
.icon-btn:hover{transform:translateY(-1px);border-color:var(--blue)}
.progress{height:10px;background:var(--card);border:1px solid var(--stroke);border-radius:999px;overflow:hidden}
.progress-bar{height:100%;width:0%;background:linear-gradient(90deg,var(--blue),#60a5fa);transition:width .3s var(--e)}
.progress-meta{color:var(--muted);font-size:.85rem;margin:6px 0 14px}
.agregarTareas{display:flex;gap:10px;align-items:center;padding:8px;background:var(--card);border:1px solid var(--stroke);border-radius:14px;margin-bottom:14px}
.agregarTareas input{flex:1;height:44px;background:transparent;border:0;color:var(--text);padding:0 12px;outline:none}
.add-btn{width:44px;height:44px;border-radius:12px;border:0;background:var(--blue);color:#fff;font-size:28px;line-height:0;cursor:pointer;transition:transform .2s var(--e),background .2s var(--e)}
.add-btn:hover{background:var(--blue-500);transform:translateY(-1px)}
.seccionTareas h3{font-size:1rem;margin:10px 0}
.seccionTareas>ul{list-style:none;display:grid;gap:10px}
.seccionTareas li{display:grid;grid-template-columns:28px 1fr auto;align-items:center;gap:12px;padding:12px;border:1px solid var(--stroke);border-radius:14px;background:linear-gradient(180deg,#0b1324,#0b0f1a);transition:border-color .2s var(--e),transform .2s var(--e),opacity .2s var(--e)}
.seccionTareas li:hover{border-color:#2d4e94;transform:translateY(-1px)}
.seccionTareas p{font-size:.98rem;line-height:1.3}
.check,.delete{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;cursor:pointer;position:relative;border:0;background:transparent}
.check{border:2px solid #334155;transition:all .28s var(--e)}
.check::after{content:"";position:absolute;width:12px;height:6px;border:2px solid transparent;border-top:0;border-right:0;transform:rotate(-45deg) scale(.6);top:7px;left:6px;opacity:0;transition:transform .28s var(--e),opacity .28s var(--e),border-color .28s var(--e)}
.delete{opacity:.75}
.delete::before,.delete::after{content:"";position:absolute;width:12px;height:2px;background:#9aa6bf;top:13px;left:8px;border-radius:1px}
.delete::before{transform:rotate(45deg)}.delete::after{transform:rotate(-45deg)}
.delete:hover{opacity:1}
li.done .check{background:var(--blue);border-color:var(--blue);box-shadow:0 0 0 6px rgba(37,99,235,.16)}
li.done .check::after{border-color:#fff;opacity:1;transform:rotate(-45deg) scale(1)}
.line-through{text-decoration:line-through;color:var(--muted)}
li.remove{animation:slideOut .22s var(--e) forwards}
@keyframes slideOut{to{transform:translateX(-12px);opacity:0}}
@media(prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important}}
</style>
</head>
<body>
  <div class="container">
    <header class="perfil">
      <h1>Mi Todo</h1>
      <span id="fecha"></span>
      <div class="date-controls">
        <button id="prevDay" class="icon-btn" aria-label="Día anterior">◀</button>
        <input type="date" id="datePicker" />
        <button id="nextDay" class="icon-btn" aria-label="Día siguiente">▶</button>
      </div>
    </header>

    <div class="progress"><div class="progress-bar" id="progressBar"></div></div>
    <div class="progress-meta"><span id="progressText">0% • 0/0</span></div>

    <div class="agregarTareas">
      <input id="input" type="text" placeholder="Escribe una tarea..." />
      <button id="enter" class="add-btn" type="button" aria-label="Añadir">+</button>
    </div>

    <section class="seccionTareas">
      <h3>Tareas</h3>
      <ul id="lista" aria-live="polite"></ul>
    </section>
  </div>

<script>
// === Todo con memoria por día + progreso + arrastre automático real + pendientes arriba (V3) ===

// -------------------- Selectores --------------------
const $ = (q,ctx=document)=>ctx.querySelector(q);
const btnSend       = $('#enter');
const inputTarea    = $('#input');
const listaTareas   = $('#lista');
const fechaLabel    = $('#fecha');
const datePicker    = $('#datePicker');
const prevDayBtn    = $('#prevDay');
const nextDayBtn    = $('#nextDay');
const progressBar   = $('#progressBar');
const progressText  = $('#progressText');

// -------------------- Fechas --------------------
const pad = n => String(n).padStart(2,'0');
const keyFromDate = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const dateFromKey = k => { const [y,m,d] = k.split('-').map(Number); return new Date(y, m-1, d); };
const newId = () => (crypto?.randomUUID ? crypto.randomUUID()
                 : `${Date.now().toString(36)}${Math.random().toString(36).slice(2,8)}`);

// -------------------- Storage --------------------
const STORAGE_KEY = 'TODO_BY_DATE_V3';
let STATE = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');

// (migración por si venías de V2)
(function migrateFromV2(){
  const V2 = localStorage.getItem('TODO_BY_DATE_V2');
  if(!V2) return;
  try{
    const old = JSON.parse(V2);
    if(old && typeof old === 'object'){
      Object.keys(old).forEach(k=>{
        const arr = Array.isArray(old[k]) ? old[k] : [];
        const mapped = arr.map(x=>{
          const id = (x.id?.toString()) || newId();
          return {
            id,
            origin: x.origin || id,
            nombre: x.nombre ?? 'Tarea',
            realizado: !!x.realizado,
            eliminado: !!x.eliminado,
            createdAt: x.createdAt || Date.now()
          };
        });
        STATE[k] = Array.isArray(STATE[k]) ? [...STATE[k], ...mapped] : mapped;
      });
      localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE));
      localStorage.removeItem('TODO_BY_DATE_V2');
    }
  }catch(e){}
})();

// -------------------- Estado inicial --------------------
let CURRENT_KEY = keyFromDate(new Date());
datePicker.value = CURRENT_KEY;
updateFechaLabel();
let list = ensureList();

// Traer pendientes de días anteriores al día actual (¡clave!)
ensureCarryForwardFor(CURRENT_KEY);
render();

// -------------------- Core --------------------
function ensureList(){
  if(!Array.isArray(STATE[CURRENT_KEY])) STATE[CURRENT_KEY] = [];
  STATE[CURRENT_KEY] = STATE[CURRENT_KEY].map(t=>({
    ...t,
    origin: t.origin || t.id,
    createdAt: t.createdAt || Date.now()
  }));
  return STATE[CURRENT_KEY];
}
function save(){
  STATE[CURRENT_KEY] = list;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(STATE));
}
function updateFechaLabel(){
  const d = dateFromKey(CURRENT_KEY);
  const lbl = d.toLocaleDateString('es-ES',{weekday:'long',month:'short',day:'numeric'});
  fechaLabel.textContent = lbl.charAt(0).toUpperCase()+lbl.slice(1);
}
function escapeHtml(s){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]))}

// --- Arrastre automático verdadero ---
// Toma el ÚLTIMO estado de cada "origin" en cualquier fecha < currKey.
// Si está pendiente (no realizado ni eliminado), lo replica en currKey (evitando duplicados).
function ensureCarryForwardFor(currKey){
  const prevKeys = Object.keys(STATE).filter(k => k < currKey).sort(); // YYYY-MM-DD ordena bien
  if(prevKeys.length === 0) return;

  // Normaliza tasks antiguas
  prevKeys.forEach(k=>{
    if(Array.isArray(STATE[k])){
      STATE[k] = STATE[k].map(t=>({...t, origin:t.origin||t.id, createdAt:t.createdAt||Date.now()}));
    }
  });

  const latestByOrigin = new Map();
  prevKeys.forEach(k=>{
    (STATE[k] || []).forEach(t=>{
      latestByOrigin.set(t.origin, {...t, _date:k});
    });
  });

  list = ensureList();
  const existingOrigins = new Set(list.filter(t=>!t.eliminado).map(t=>t.origin));
  let added = 0;

  latestByOrigin.forEach((t, origin)=>{
    if(t.eliminado) return;
    if(t.realizado) return;            // solo arrastramos pendientes
    if(existingOrigins.has(origin)) return; // ya está presente hoy
    list.push({
      id: newId(),
      origin,
      nombre: t.nombre,
      realizado: false,
      eliminado: false,
      createdAt: Date.now()
    });
    added++;
  });

  if(added) save();
}

// -------------------- Render con pendientes arriba --------------------
function getVisibleTasksSorted(){
  const visible = list.filter(t=>!t.eliminado);
  return visible.sort((a,b)=>{
    const byDone = Number(a.realizado) - Number(b.realizado); // 0(pend) primero
    if(byDone !== 0) return byDone;
    return (a.createdAt||0) - (b.createdAt||0);
  });
}
function agregarTarea(tarea, id, realizado){
  const LINE = realizado ? 'line-through' : '';
  const DONE = realizado ? 'done' : '';
  listaTareas.insertAdjacentHTML('beforeend', `
    <li class="${DONE}" data-id="${id}">
      <button class="check"  data-action="toggle" data-id="${id}" aria-label="Completar"></button>
      <p class="text ${LINE}">${escapeHtml(tarea)}</p>
      <button class="delete" data-action="delete" data-id="${id}" aria-label="Eliminar"></button>
    </li>
  `);
}
function render(){
  listaTareas.innerHTML = '';
  getVisibleTasksSorted().forEach(t => agregarTarea(t.nombre, t.id, t.realizado));
  updateProgress();
}
function updateProgress(){
  const total = list.filter(t=>!t.eliminado).length;
  const done  = list.filter(t=>!t.eliminado && t.realizado).length;
  const pct   = total ? Math.round(done/total*100) : 0;
  progressBar.style.width = `${pct}%`;
  progressText.textContent = `${pct}% • ${done}/${total}`;
}

// -------------------- CRUD --------------------
function addFromInput(){
  const tarea = inputTarea.value.trim();
  if(!tarea) return;
  const id = newId();
  list.push({ id, origin:id, nombre:tarea, realizado:false, eliminado:false, createdAt:Date.now() });
  inputTarea.value = '';
  save(); render();
}
function toggleTask(id){
  const i = list.findIndex(t=>t.id===id); if(i<0) return;
  list[i].realizado = !list[i].realizado;
  save(); render();
}
function deleteTask(id){
  const i = list.findIndex(t=>t.id===id); if(i<0) return;
  list[i].eliminado = true;
  save(); render();
}

// -------------------- Eventos --------------------
btnSend.addEventListener('click', addFromInput);
inputTarea.addEventListener('keyup', e=>{ if(e.key==='Enter') addFromInput(); });
listaTareas.addEventListener('click', e=>{
  const btn = e.target.closest('[data-action]'); if(!btn) return;
  const {action,id} = btn.dataset;
  if(action==='toggle') toggleTask(id);
  if(action==='delete') deleteTask(id);
});

// Cambio de día: SIEMPRE arrastrar pendientes al entrar a esa fecha
datePicker.addEventListener('change', ()=>{
  CURRENT_KEY = datePicker.value;
  list = ensureList();
  ensureCarryForwardFor(CURRENT_KEY);
  updateFechaLabel();
  render();
});
prevDayBtn.addEventListener('click', ()=>{
  const d = dateFromKey(CURRENT_KEY); d.setDate(d.getDate()-1);
  CURRENT_KEY = keyFromDate(d);
  datePicker.value = CURRENT_KEY;
  list = ensureList();
  ensureCarryForwardFor(CURRENT_KEY);
  updateFechaLabel();
  render();
});
nextDayBtn.addEventListener('click', ()=>{
  const d = dateFromKey(CURRENT_KEY); d.setDate(d.getDate()+1);
  CURRENT_KEY = keyFromDate(d);
  datePicker.value = CURRENT_KEY;
  list = ensureList();
  ensureCarryForwardFor(CURRENT_KEY);
  updateFechaLabel();
  render();
});
</script>

</body>
</html>

</html>
